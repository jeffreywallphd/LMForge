{% extends 'base.html' %}

{% block content %}
<h1>Welcome to LMForge</h1>
<p>This software is designed to simplify the process of creating datasets for fine-tuning language models and fine-tuning new models for specific purposes. The software is configurable to work with common AI tools, including HuggingFace, Weights and Biases, and OpenAI. If you haven't, please <a href="{% url 'settings-view' %}">configure the software here</a>.</p>

{% if messages %}
    <div class="alert alert-info">
        <ul class="mb-0">
            {% for message in messages %}
            <li>{{ message }}</li>
            {% endfor %}
        </ul>
    </div>
{% endif %}

<h2>Database Chunks Collections</h2>
<div>
    <a href="{% url 'dataset-workflow' %}" class="button success">+ New Vector Database</a>
    <div class="table-responsive workflow-table">
        <table class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th>Collection</th>
                    <th>Chunks</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% if collections %}
                    {% for c in collections %}
                    <tr>
                        <td>{{ c.name }}</td>
                        <td>{{ c.count }}</td>
                        <td>
                            <a href="{% url 'database-workflow' %}?collection={{ c.name }}" class="button">
                                View / Manage
                            </a>
                            <!-- Delete button -->
                            <button type="button" class="button danger delete-btn" data-name="{{ c.name }}">
                                Delete
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr><td colspan="3" class="text-center">No collections found.</td></tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<h2>Datasets</h2>
<div>
    <a href="{% url 'dataset-workflow' %}" class="button success">+ New Dataset</a>
    <div class="table-responsive workflow-table">
        <table class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th>Dataset</th>
                    <th>Created</th>
                    <th>Downloads</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for dataset in datasets %}
                <tr>
                    <td>{{ dataset.id }}</td>
                    <td>{{ dataset.created_at }}</td>
                    <td>{{ dataset.downloads }}</td>
                    <td><a href="" class="button">Edit</a></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
<h2>Models</h2>
<div>
    <a href="{% url 'train-model-workflow' %}" class="button success">+ New Model</a>
    <div class="table-responsive workflow-table">
        <table class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th>Model</th>
                    <th>Created</th>
                    <th>Downloads</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for model in models %}
                <tr>
                    <td>{{ model.id }}</td>
                    <td>{{ model.created_at }}</td>
                    <td>{{ model.downloads }}</td>
                    <td><a href="" class="button">Edit</a></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
<script>
function getCSRFToken() {
    let name = 'csrftoken';
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

document.addEventListener("DOMContentLoaded", function() {
    fetch("/api/collections_summary/")
        .then(response => response.json())
        .then(data => {
            const tbody = document.getElementById("collections-body");
            tbody.innerHTML = "";
            if (data.length === 0) {
                tbody.innerHTML = "<tr><td colspan='3'>No collections found</td></tr>";
                return;
            }
            data.forEach(col => {
                const row = `
                    <tr>
                        <td>${col.name}</td>
                        <td>${col.count}</td>
                        <td><a href="/database-workflow/?collection_name=${encodeURIComponent(col.name)}" class="button">View / Manage</a></td>
                    </tr>
                `;
                tbody.insertAdjacentHTML("beforeend", row);
            });
        })
        .catch(error => {
            console.error("Error fetching collections:", error);
            const tbody = document.getElementById("collections-body");
            tbody.innerHTML = "<tr><td colspan='3'>Failed to load collections</td></tr>";
        });
});

document.addEventListener("DOMContentLoaded", function() {
    document.querySelectorAll(".delete-btn").forEach(btn => {
        btn.addEventListener("click", async () => {
            const name = btn.dataset.name;
            if (!confirm(`Are you sure you want to delete ${name}?`)) return;

            try {
                const res = await fetch(window.location.href, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": getCSRFToken()
                    },
                    body: JSON.stringify({ collection_name: name })
                });

                if (res.ok) {
                    alert(`${name} deleted successfully`);
                    location.reload();
                } else {
                    alert(`Failed to delete ${name}.`);
                }
            } catch (err) {
                console.error(err);
                alert("Error occurred while deleting collection.");
            }
        });
    });
});
</script>
{% endblock %}